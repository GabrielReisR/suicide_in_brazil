---
title: "Suicídio no Brasil - de 2010 a 2019"
author: "Gabriel R. R."
date: "Última atualização: 04/05/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    smooth_scroll: true
    df_print: paged
    code_folding: show
---
```{r setup and pre_processing, warning = FALSE, message = FALSE, echo = FALSE}
# Initializing ====
# Loading libraries
load_libraries <- function(){
  if (!require("dplyr"))
    install.packages("dplyr")
  if (!require("forcats"))
    install.packages("forcats")
  if(!require("geobr"))
    install.packages("geobr")
  if (!require("gganimate"))
    install.packages("gganimate")
  if (!require("ggplot2"))
    install.packages("ggplot2")
  if(!require("gifski"))
    install.packages("gifski")
  if(!require("lubridate"))
    install.packages("lubridate")
  if(!require("magrittr"))
    install.packages("magrittr")
  if(!require("maps"))
    install.packages("maps")
  if(!require("plotly"))
    install.packages("plotly")
  if(!require("psych"))
    install.packages("psych")
  if(!require("scales"))
    install.packages("scales")
  if(!require("sf"))
    install.packages("sf")
  if(!require("stringr"))
    install.packages("stringr")
}

load_libraries()

# Getting data
df <- read.csv('D:\\Data Science\\Projetos\\suicide_in_brazil\\data\\df.csv',
               encoding = 'UTF-8')[-1]

# Creating design objects ====
create_design <- function(){
  # Fill color
  fill_color <- '#f68060'
  
  # Caption
  caption <- 'Dados do DATASUS entre os anos de 2010 e 2019 extraídos com PySUS.'
  
  # Setting main theme
  project_theme <- 
    theme_minimal() + 
    theme(legend.position = "none",
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_blank(),
          plot.title = element_text(size = 16),
          plot.subtitle = element_text(size = 15),
          axis.text = element_text(size = 12),
          axis.title = element_text(size = 14))
  
  # Setting map theme
  project_map_theme <-
    theme_minimal() + 
    theme(panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_blank(),
          plot.title = element_text(size = 16),
          plot.subtitle = element_text(size = 15),
          axis.text = element_blank(),
          axis.title = element_blank())
  
  list_of_objects <- list(
    'fill_color' = fill_color,
    'caption' = caption,
    'project_theme' = project_theme,
    'project_map_theme' = project_map_theme
  )
  
  return(list_of_objects)
}

design <- create_design()

# Initial cleaning ====
clean_data <- function(df){
  # Making missings known
  df[df == 'NaN'] <- NA
  
  # State as factor
  df$estado %<>% as.factor
  
  # Arranging dates
  format <- "%d%m%Y"
  df$DTOBITO <- parse_date_time(df$DTOBITO, format)
  df$DTNASC <- parse_date_time(df$DTNASC, format)
  
  # Creating 'month' column
  df$mes <- month(df$DTOBITO)
  
  # Sex as factor
  df$SEXO %<>% as.factor
  
  # Race/color as factor
  df$RACACOR[df$RACACOR == ''] <- NA
  df$RACACOR %<>% as.factor
  
  
  # Medical assistance as factor
  df$ASSISTMED[df$ASSISTMED == ''] <- NA
  df$ASSISTMED %<>% as.factor
  
  # Mother's education as factor
  df$ESCMAE %<>% as.factor
  df$ESCMAE <- factor(df$ESC,
                      levels = c('1 a 3 anos',
                                 '4 a 7 anos',
                                 '8 a 11 anos',
                                 '12 e mais'))
  
  # Marital status as factor
  df$ESTCIV %<>% as.factor
  df$ESTCIV <- factor(df$ESTCIV,
                      levels = c('Solteiro',
                                 'União consensual',
                                 'Casado',
                                 'Separado judicialmente',
                                 'Viúvo'))
  
  levels(df$ESTCIV)[1] <- 'Solteiro/a'
  levels(df$ESTCIV)[3] <- 'Casado/a'
  levels(df$ESTCIV)[4] <- 'Separado/a judicialmente'
  levels(df$ESTCIV)[5] <- 'Viúvo/a'
  
  # Education as factor
  df$ESC %<>% as.factor
  df$ESC <- factor(df$ESC,
                   levels = c('Nenhuma',
                              '1 a 3 anos',
                              '4 a 7 anos',
                              '8 a 11 anos',
                              '12 e mais'))
  
  # Ocupation as factor
  df$OCUP %<>% as.factor
  
  df$OCUP[str_detect(df$OCUP, "\\d")] <- NA
  #' This last function corrects a problem found in the data.
  #' A lot of occupations were not coded correctly by the CBO.
  #' The reason why this happened is unclear.
  #' This resulted in various data points containing 'random' numbers,
  #' such as '1021', '11112' and '14221'. This should be an ocupation,
  #' however, I can't seem to find the code for it, and the CBO isn't
  #' covering this properly. If you know something about this, feel free
  #' to contact me.
  #' 
  #' What the code does is the following:
  #' Detect in `df$OCUP` any string that contains numbers (`\\d` in regex).
  #' When you find this, replace with `NA` (`<- NA`)
  
  # Place of occurence as factor
  df$LOCOCOR[df$LOCOCOR == '6'] <- NA #' There isn't code for '6': replace with NA
  df$LOCOCOR %<>% as.factor
  
  # Received surgery (yes/no) as factor
  df$CIRURGIA[df$CIRURGIA == ''] <- NA
  df$CIRURGIA %<>% as.factor
  
  return(df)
}

df <- clean_data(df)

# Creating dataframes with number of deaths by month/year ====
year_total <- df %>% group_by(ano) %>% count()

month_total <- df %>% group_by(mes) %>% count()

ym_total <- df %>% 
  group_by(ano, mes) %>% 
  count() %>% 
  tidyr::unite(mes, ano, col = 'index', sep = '-')

# Creating variations in percentage from one time period to another ====
#' *year_variation*
year_variation <- as.data.frame(year_total)
rownames(year_variation) <- year_variation$ano
year_variation %<>% select(-ano)

year_variation <- as.ts(year_variation, start = c(2010), frequency = 1)

year_variation <- year_variation/stats::lag(year_variation, -1) - 1

year_variation <- as.data.frame(year_variation)
#' *month variation*
month_variation <- as.data.frame(month_total)
rownames(month_variation) <- month_variation$mes
month_variation %<>% select(-mes)

month_variation <- as.ts(month_variation, start = c(1), frequency = 1)

month_variation <- month_variation/stats::lag(month_variation, -1) - 1

month_variation <- as.data.frame(month_variation)

#' *ym_variation*
ym_variation <- as.data.frame(ym_total)
rownames(ym_variation) <- ym_variation$index
ym_variation %<>% select(-index)
rownames(ym_variation) <- NULL

ym_variation <- as.ts(ym_variation, start = c(2010, 1), frequency = 12)

ym_variation <- ym_variation/stats::lag(ym_variation, -1) - 1

ym_variation <- as.data.frame(ym_variation)
```

## Sobre
Esse trabalho é um projeto pessoal realizado a fim de exercitar habilidades em
visualização de dados e jornalismo de dados usando R. Todas as figuras formadas
utilizaram o pacote *ggplot2*. Os gifs foram feitos através do pacote
*gganimate*. Além de utilizar o *ggplot2*, os mapas foram criados a partir dos 
pacotes *geobr*, *maps* e *sf* (um agradecimento especial ao código fornecido
por Gerson Júnior e Henrique Martins na iniciativa 
[*Open Code Community*](https://opencodecom.net/post/2021-04-20-criando-mapas-no-r-mundo-e-brasil/)).

O objetivo principal para realização do trabalho não interferiu na qualidade de
tratamento dos dados. Os dados foram extraídos utilizando-se a ferramenta [PySUS](https://github.com/AlertaDengue/PySUS),
seguindo-se o tutorial descrito [aqui](https://medium.com/psicodata/baixando-e-processando-dados-do-datasus-sobre-suic%C3%ADdio-com-python-656afa17f6ad?source=friends_link&sk=4e94866d21707aefec13aafe5923d6f1), como 
reiterados nesse vídeo [aqui](https://www.youtube.com/watch?v=7TxlU5mgABk).

Foram baixados os dados de 2010 a 2019, contemplando 10 anos de uma série 
histórica.
Os dados foram pré-processados em Python, podendo todos os procedimentos 
iniciais de pré-processamento serem verificados [neste link](https://github.com/GabrielReisR/suicide_in_brazil/blob/main/getting_pysus_data_2010_2019.ipynb).
A manipulação de dados para realização das análises e criação das visualizções 
foram realizadas em R, conforme descrito
[nesse documento aqui](https://github.com/GabrielReisR/suicide_in_brazil/blob/main/analyses/analyses.R).

O repositório no GitHub para esse trabalho está
[aqui](https://github.com/GabrielReisR/suicide_in_brazil/). Todas as análises
aqui descritas devem ser passíveis de replicação direta ao se executar o código
presente no repositório.

Qualquer dúvida, comentário ou retificação podem ser enviadas para 
reisrgabriel@gmail.com

## Série temporal
#### Variação ao longo dos anos
```{r, echo = FALSE, out.width = "100%", fig.align = 'center'}
knitr::include_graphics("../figures/suicide_var_by_year.png")
```



#### Visualização da série histórica

![](D:/Data Science/Projetos/suicide_in_brazil/figures/suicides_across_years.gif) 

#### Suicídios por sexo

Em geral, os homens cometem mais suicídios que as mulheres no Brasil. O número absoluto de suicídios registrados em homens foi de 88394 para homens (78,58%) e 24075	para mulheres (21,40%).

```{r tabela de sexo por ano, echo = F}
df %>% 
  group_by(ano, SEXO) %>% 
  count()
```

```{r, echo = FALSE, out.width = "75%", fig.align = 'center'}
knitr::include_graphics("../figures/suicides_by_sex_by_year.gif")
```

## Ocupações

Desde 2010 até 2019, apenas 10 profissões/ocupações estão presentes no topo dos casos de suicídio. Em números absolutos, a ordem de suicídios por profissão é a seguinte:

```{r tabela de ocupacoes por ano, echo = F}
df$OCUP %<>% as.factor

df$OCUP[str_detect(df$OCUP, "\\d")] <- NA

df %>%
  
  # Cleaning
  filter(OCUP != 'NA') %>% 
  
  group_by(OCUP) %>% 
  
  summarize(n = n()) %>%
  
  arrange(desc(n), .by_group = T) %>% 
  
  mutate(ordem = 1:n())
```

Por ano, percebe-se uma evolução no número de casos registrados de suicídios por estudantes. Separando-se apenas as 10 profissões mais relevantes a cada ano, a ordem é a seguinte:

## Estados
```{r, echo = FALSE, out.width = "75%", fig.align = 'center'}
knitr::include_graphics("../figures/suicide_by_states.png")
```

